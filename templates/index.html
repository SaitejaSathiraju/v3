<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üì∏ Photo Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    img {
      -webkit-user-drag: none;
      user-select: none;
      pointer-events: none;
    }

    /* Center all content */
    .centered-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Image preview styles */
    .image-preview {
      max-width: 300px;
      max-height: 300px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Loading animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col">
  
  <!-- Main Centered Container -->
  <div class="centered-container">
    
    <!-- Combined Face Recognition Search & Photo Search Section -->
    <div class="w-full max-w-6xl mx-auto mt-8 mb-6 p-6 bg-white rounded-lg shadow-lg">
      <h2 class="text-3xl font-bold mb-6 text-center text-blue-600">üîç Face Recognition Search & üì∏ Photo Search</h2>
      
      <!-- Upload and Search Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-6">
        
        <!-- Left Side: Image Upload and Preview -->
        <div class="space-y-4">
          <h3 class="text-xl font-semibold text-gray-700">Upload Image for Face Search</h3>
          <form id="faceSearchForm" enctype="multipart/form-data" class="space-y-4">
            <label class="w-full flex flex-col items-center px-6 py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 cursor-pointer hover:bg-gray-100 transition-colors duration-200">
              <svg class="w-12 h-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg>
              <span class="text-gray-600 font-semibold mb-2">Click to select an image</span>
              <span class="text-sm text-gray-500">JPG, PNG, GIF up to 10MB</span>
              <input id="imageUpload" name="file" type="file" accept="image/*" class="hidden" required />
            </label>
            
            <!-- Image Preview -->
            <div id="imagePreviewContainer" class="hidden">
              <h4 class="text-lg font-medium text-gray-700 mb-3">Selected Image:</h4>
              <img id="previewImg" src="#" alt="Preview" class="image-preview w-full" />
            </div>
            
            <button id="searchButton" type="submit" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold shadow-lg hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
              üîç Search for Faces
            </button>
          </form>
          
          <!-- Loading Bar -->
          <div id="loadingContainer" class="hidden space-y-3">
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
              <div id="loadingProgress" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
            </div>
            <div class="flex items-center justify-center space-x-2">
              <div class="w-4 h-4 bg-blue-500 rounded-full loading-pulse"></div>
              <p class="text-center text-gray-600 font-medium">Processing image, please wait...</p>
            </div>
          </div>
        </div>
        
        <!-- Right Side: Search Results -->
        <div class="space-y-4">
          <h3 class="text-xl font-semibold text-gray-700">Face Search Results</h3>
          <div id="faceSearchResults" class="space-y-6">
            <div class="text-center text-gray-500 py-8">
              <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              <p class="text-sm">Upload an image to start searching</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Filters Container -->
      <div id="filtersContainer" class="bg-gray-50 p-6 rounded-lg border border-gray-200 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 w-full">
        <!-- Year Filter -->
        <div class="space-y-2">
          <label class="text-sm font-medium text-gray-700">Year</label>
          <select id="filterYear" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-colors" onchange="onFilterChange()">
            <option value="">All Years</option>
          </select>
        </div>
        
        <!-- Month Filter -->
        <div class="space-y-2">
          <label class="text-sm font-medium text-gray-700">Month</label>
          <select id="filterMonth" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-colors" onchange="onFilterChange()">
            <option value="">All Months</option>
          </select>
        </div>
        
        <!-- Date Filter -->
        <div class="space-y-2">
          <label class="text-sm font-medium text-gray-700">Specific Date</label>
          <input type="date" id="filterDate" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-colors" onchange="onFilterChange()">
        </div>
        
        <!-- Event Name Filter -->
        <div class="space-y-2">
          <label class="text-sm font-medium text-gray-700">Event Name</label>
          <input type="text" id="filterName" placeholder="Search by Event Name" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition-colors" oninput="onFilterChange()">
        </div>
      </div>
    </div>

    <!-- Results Display - Positioned below the combined section -->
    <div id="resultsDisplay" class="w-full max-w-6xl mx-auto mt-4 hidden">
      <div id="noResultsMessage" class="text-center text-gray-500 py-4">
        <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.47-.881-6.08-2.33"></path>
        </svg>
        <p class="text-lg">No matches found for this image.</p>
      </div>
      
      <div id="strongMatchesSection" class="mb-6 hidden">
        <h3 class="text-xl font-semibold text-green-700 mb-4 flex items-center">
          <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          Strong Matches
        </h3>
        <div id="strongMatchesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
      </div>
      
      <div id="doubtfulMatchesSection" class="mb-6 hidden">
        <h3 class="text-xl font-semibold text-yellow-700 mb-4 flex items-center">
          <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          Doubtful Matches
        </h3>
        <div id="doubtfulMatchesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
      </div>
    </div>

    <!-- Server-side fallback for non-JS users -->
    {% if strong_images or doubtful_images %}
      <div class="w-full max-w-6xl mx-auto mt-4">
        {% if strong_images %}
          <h3 class="text-xl font-semibold text-green-700 mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            Strong Matches
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6 server-strong">
            {% for img in strong_images %}
              <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-200">
                <img src="{{ url_for('static', filename=img.path) }}" alt="Strong match" class="w-full h-48 object-cover" />
                <div class="p-3">
                  <p class="text-sm font-medium text-gray-800 truncate">{{ img.original_name }}</p>
                  <p class="text-xs text-gray-500">Distance: {{ "%.3f"|format(img.distance) }}</p>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
        {% if doubtful_images %}
          <h3 class="text-xl font-semibold text-yellow-700 mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
            Doubtful Matches
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 server-doubtful">
            {% for img in doubtful_images %}
              <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-200">
                <img src="{{ url_for('static', filename=img.path) }}" alt="Doubtful match" class="w-full h-48 object-cover" />
                <div class="p-3">
                  <p class="text-sm font-medium text-gray-800 truncate">{{ img.original_name }}</p>
                  <p class="text-xs text-gray-500">Distance: {{ "%.3f"|format(img.distance) }}</p>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% endif %}

    <!-- Albums + Photos Container -->
    <div id="contentContainer" class="w-full max-w-6xl mx-auto px-4 py-6 hidden flex flex-col items-center">
      <h2 class="text-2xl font-semibold mb-6" id="albumsHeading">Albums Found</h2>

      <div id="albumGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 w-full"></div>

      <button id="backButton" class="mt-6 hidden bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center" onclick="backToAlbums()">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back to Albums
      </button>

      <div id="photosContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 w-full mt-8 hidden"></div>
    </div>

  </div>

  <!-- Load photosData -->
  <script src="photosData.js"></script>

  <script>
    // DOM Elements
    const yearSelect = document.getElementById('filterYear');
    const monthSelect = document.getElementById('filterMonth');
    const dateInput = document.getElementById('filterDate');
    const nameInput = document.getElementById('filterName');
    const albumGrid = document.getElementById('albumGrid');
    const photosContainer = document.getElementById('photosContainer');
    const contentContainer = document.getElementById('contentContainer');
    const backButton = document.getElementById('backButton');
    const imageUpload = document.getElementById('imageUpload');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const previewImg = document.getElementById('previewImg');
    const faceSearchForm = document.getElementById('faceSearchForm');
    const loadingContainer = document.getElementById('loadingContainer');
    const searchButton = document.getElementById('searchButton');
    const faceSearchResults = document.getElementById('faceSearchResults');
    const resultsDisplay = document.getElementById('resultsDisplay');

    let currentAlbums = {};
    let activeAlbumKey = null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      populateFilters();
      setupEventListeners();
    });

    function setupEventListeners() {
      // Image upload preview
      imageUpload.addEventListener('change', previewImage);
      
      // Face search form submission
      faceSearchForm.addEventListener('submit', startFaceSearch);
    }

    function populateFilters() {
      if (typeof photos === 'undefined') return;
      
      const years = [...new Set(photos.map(p => p.year))].sort();
      const months = [...new Set(photos.map(p => p.month))].sort();

      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      });

      months.forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month.replace(/_/g, ' ');
        monthSelect.appendChild(option);
      });
    }

    function previewImage(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.src = e.target.result;
          imagePreviewContainer.classList.remove('hidden');
          searchButton.disabled = false;
        };
        reader.readAsDataURL(file);
      } else {
        previewImg.src = '';
        imagePreviewContainer.classList.add('hidden');
        searchButton.disabled = true;
      }
    }

    function startFaceSearch(event) {
      event.preventDefault();
      
      if (!imageUpload.files[0]) {
        alert('Please select an image first!');
        return;
      }

      // Show loading bar
      loadingContainer.classList.remove('hidden');
      searchButton.disabled = true;
      resultsDisplay.classList.add('hidden');
      
      // Simulate loading progress - SLOWER and more realistic
      const progressBar = document.getElementById('loadingProgress');
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 8 + 2; // Slower progress: 2-10% per step
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
        }
        progressBar.style.width = progress + '%';
      }, 400); // Slower: 400ms per step instead of 200ms

      // Prepare form data
      const formData = new FormData();
      formData.append('file', imageUpload.files[0]);

      fetch('/', {
        method: 'POST',
        body: formData
      })
      .then(response => response.text())
      .then(html => {
        // Parse the HTML response to extract results
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Extract results - look for images in the results folder
        const strongImgs = doc.querySelectorAll('.server-strong img, img[src*="/static/results/"]');
        const doubtfulImgs = doc.querySelectorAll('.server-doubtful img');
        
        // Also check if there are any images in the results folder
        if (strongImgs.length === 0 && doubtfulImgs.length === 0) {
          // Try to find any images that might be results
          const allImages = doc.querySelectorAll('img[src*="/static/results/"]');
          if (allImages.length > 0) {
            // If we found results images, treat them as strong matches
            displayFaceSearchResults(allImages, []);
          } else {
            displayFaceSearchResults([], []);
          }
        } else {
          displayFaceSearchResults(strongImgs, doubtfulImgs);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during face search. Please try again.');
      })
      .finally(() => {
        loadingContainer.classList.add('hidden');
        searchButton.disabled = false;
        progressBar.style.width = '0%';
      });
    }

    function displayFaceSearchResults(strongImgs, doubtfulImgs) {
      const strongGrid = document.getElementById('strongMatchesGrid');
      const doubtfulGrid = document.getElementById('doubtfulMatchesGrid');
      const noResultsMessage = document.getElementById('noResultsMessage');
      const strongSection = document.getElementById('strongMatchesSection');
      const doubtfulSection = document.getElementById('doubtfulMatchesSection');
      
      // Clear previous results
      strongGrid.innerHTML = '';
      doubtfulGrid.innerHTML = '';
      
      // Display strong matches
      if (strongImgs.length > 0) {
        strongSection.classList.remove('hidden');
        strongImgs.forEach(img => {
          const resultItem = document.createElement('div');
          resultItem.className = 'bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-200';
          
          // Extract filename from src
          const filename = img.src.split('/').pop();
          
          resultItem.innerHTML = `
            <img src="${img.src}" alt="Strong match" class="w-full h-48 object-cover" />
            <div class="p-3">
              <p class="text-sm font-medium text-gray-800 truncate">${filename}</p>
            </div>
          `;
          strongGrid.appendChild(resultItem);
        });
      } else {
        strongSection.classList.add('hidden');
      }
      
      // Display doubtful matches
      if (doubtfulImgs.length > 0) {
        doubtfulSection.classList.remove('hidden');
        doubtfulImgs.forEach(img => {
          const resultItem = document.createElement('div');
          resultItem.className = 'bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-200';
          
          // Extract filename from src
          const filename = img.src.split('/').pop();
          
          resultItem.innerHTML = `
            <img src="${img.src}" alt="Doubtful match" class="w-full h-48 object-cover" />
            <div class="p-3">
              <p class="text-sm font-medium text-gray-800 truncate">${filename}</p>
            </div>
          `;
          doubtfulGrid.appendChild(resultItem);
        });
      } else {
        doubtfulSection.classList.add('hidden');
      }
      
      // Show no results message if no matches found
      if (strongImgs.length === 0 && doubtfulImgs.length === 0) {
        noResultsMessage.classList.remove('hidden');
      } else {
        noResultsMessage.classList.add('hidden');
      }
      
      resultsDisplay.classList.remove('hidden');
      
      // Scroll to results
      resultsDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function groupPhotos(photoList) {
      const groups = {};
      photoList.forEach(photo => {
        const key = `${photo.date}__${photo.name}`;
        if (!groups[key]) groups[key] = [];
        groups[key].push(photo);
      });
      return groups;
    }

    function onFilterChange() {
      if (typeof photos === 'undefined') return;
      
      const yearFilter = yearSelect.value;
      const monthFilter = monthSelect.value;
      const dateFilter = dateInput.value;
      const nameFilter = nameInput.value.toLowerCase();

      let filteredPhotos = photos.filter(photo => {
        const yearMatch = !yearFilter || photo.year == yearFilter;
        const monthMatch = !monthFilter || photo.month == monthFilter;
        const dateMatch = !dateFilter || photo.date == dateFilter;
        const nameMatch = !nameFilter || photo.name.toLowerCase().includes(nameFilter);
        
        return yearMatch && monthMatch && dateMatch && nameMatch;
      });

      if (filteredPhotos.length > 0) {
        currentAlbums = groupPhotos(filteredPhotos);
        displayAlbums();
        contentContainer.classList.remove('hidden');
        
        // Scroll to content
        contentContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        contentContainer.classList.add('hidden');
      }
    }

    function displayAlbums() {
      albumGrid.innerHTML = '';
      photosContainer.classList.add('hidden');
      backButton.classList.add('hidden');
      
      Object.keys(currentAlbums).forEach(key => {
        const album = currentAlbums[key];
        const firstPhoto = album[0];
        
        const albumCard = document.createElement('div');
        albumCard.className = 'bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-200 cursor-pointer';
        albumCard.onclick = () => displayPhotos(key);
        
        albumCard.innerHTML = `
          <img src="/static/photos/${firstPhoto.path}" alt="${firstPhoto.name}" class="w-full h-48 object-cover" />
          <div class="p-4">
            <h3 class="font-semibold text-gray-800 mb-2">${firstPhoto.name}</h3>
            <p class="text-sm text-gray-600">${firstPhoto.date} ‚Ä¢ ${album.length} photos</p>
          </div>
        `;
        
        albumGrid.appendChild(albumCard);
      });
    }

    function displayPhotos(albumKey) {
      activeAlbumKey = albumKey;
      const photos = currentAlbums[albumKey];
      
      albumGrid.classList.add('hidden');
      photosContainer.classList.remove('hidden');
      backButton.classList.remove('hidden');
      
      photosContainer.innerHTML = '';
      photos.forEach(photo => {
        const photoCard = document.createElement('div');
        photoCard.className = 'bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-200';
        
        photoCard.innerHTML = `
          <img src="/static/photos/${photo.path}" alt="${photo.name}" class="w-full h-48 object-cover" />
          <div class="p-4">
            <h3 class="font-semibold text-gray-800 mb-2">${photo.name}</h3>
            <p class="text-sm text-gray-600">${photo.date}</p>
          </div>
        `;
        
        photosContainer.appendChild(photoCard);
      });
    }

    function backToAlbums() {
      activeAlbumKey = null;
      albumGrid.classList.remove('hidden');
      photosContainer.classList.add('hidden');
      backButton.classList.add('hidden');
    }
  </script>
</body>
</html>
